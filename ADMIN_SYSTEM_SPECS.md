# AI テロップ作成ツール v2 - 管理者用システム仕様書

## 📋 システム概要

**プロジェクト名**: AI テロップ作成ツール v2  
**バージョン**: 0.2.1  
**開発フレームワーク**: Next.js 15.3.5 (React)  
**デプロイ先**: Vercel  
**最終更新**: 2025年8月10日  

### 🎯 システムの目的
動画や音声ファイルから自動でテロップ（字幕）を生成するWebアプリケーション。管理者パネルにより、ユーザー管理、使用状況監視、コスト管理を一元化。

---

## 🏗️ システム構成

### フロントエンド
- **技術**: Next.js 15.3.5 + React + TypeScript
- **スタイリング**: Tailwind CSS
- **UI コンポーネント**: カスタムコンポーネント（モーダル、フォーム等）
- **状態管理**: React Hooks (useState, useEffect)

### バックエンド
- **技術**: Next.js API Routes (サーバーレス関数)
- **認証**: カスタム認証システム（Redis セッション管理）
- **ファイル処理**: Multer (ファイルアップロード)

### データベース・ストレージ
- **メインDB**: Redis (Upstash) - ユーザー管理、セッション管理
- **ファイルストレージ**: ローカルファイルシステム + 一時ファイル
- **設定ファイル**: JSON ファイル（メール設定等）

---

## 💰 使用サービス・コスト構成

### 🔴 有料サービス

#### 1. OpenAI API ⚠️ **要残高監視**
- **用途**: 音声認識（Whisper API）+ テキスト生成（GPT API）
- **料金体系**: 従量課金制（プリペイド方式）
  - **Whisper API**: 約 $0.030 / リクエスト（推定）
  - **GPT API**: 約 $0.048 / リクエスト（推定）
  - **合計**: 約 $0.078 / リクエスト
- **課金方法**: クレジットカード（OpenAI アカウント）
- **重要**: **残高不足でシステム停止** - 定期監視必須
- **監視方法**: 
  - OpenAI Usage Dashboard: https://platform.openai.com/account/usage
  - 推奨：週次での残高確認
  - アラート設定：残高 $10 以下で通知設定推奨

### 🟡 現在無料（将来有料化の可能性）

#### 1. Upstash Redis
- **用途**: ユーザーデータ、セッション管理、使用統計
- **現在プラン**: 無料プラン
- **制限**: 256MB データ、500K コマンド/月、10GB 帯域幅/月
- **接続情報**: 
  - URL: `https://worthy-skylark-59424.upstash.io`
  - トークン: 環境変数で管理
- **課金方法**: 制限超過時は従量課金（$0.20/100Kコマンド）
- **注意**: ユーザー増加時に有料プランへの移行が必要

#### 2. Gmail SMTP（メール通知）
- **用途**: 日次レポート自動送信
- **アカウント**: nonnooz0526@gmail.com
- **認証**: アプリパスワード使用
- **制限**: Gmail の送信制限に準拠
- **コスト**: 基本無料（Gmailアカウントの一部）

### 🟢 無料サービス

#### 1. Vercel
- **用途**: ホスティング・デプロイ
- **プラン**: Hobby プラン（無料）
- **制限**: 
  - 100GB 帯域幅/月
  - 関数実行時間制限
  - Cron Jobs対応
- **独自ドメイン**: 対応可能

#### 2. GitHub
- **用途**: ソースコード管理
- **プラン**: 無料（プライベートリポジトリ対応）

---

## 👥 ユーザー管理システム

### ユーザー種別
1. **管理者（admin）**: システム全体の管理権限
2. **一般ユーザー（user）**: ツール利用のみ

### 制限システム
- **月次クレジット制**: 1分 = 1クレジット
- **デフォルト設定**: 300クレジット（5時間分）/月
- **ファイル時間制限**: 最大30分/ファイル
- **自動リセット**: 月初にクレジット自動リセット

### アクセス制御
- **セッション管理**: Redis ベース
- **ログイン制限**: 管理者による有効/無効切り替え
- **権限分離**: 管理機能は admin ユーザーのみアクセス可能

---

## 📧 メール通知システム

### 機能概要
- **日次レポート**: 自動でシステム使用状況をメール送信
- **複数宛先対応**: 最大複数アドレスに同時送信
- **送信スケジュール**: Vercel Cron Jobs使用（毎時実行チェック）

### レポート内容
1. **全体統計**: ユーザー数、リクエスト数、推定コスト
2. **ユーザー別活動**: クレジット使用状況、アクティブユーザー
3. **コスト内訳**: API別の詳細コスト分析

### 技術仕様
- **SMTP**: Gmail SMTP サーバー使用
- **認証**: OAuth2 アプリパスワード
- **送信ログ**: 成功/失敗の詳細記録
- **HTML メール**: リッチな見た目でレポート送信

---

## 🔧 システム監視・分析

### リアルタイム統計
- **総ユーザー数**: 登録済み全ユーザー
- **アクティブユーザー**: 今月1回以上利用したユーザー
- **総リクエスト数**: 累計・日次・月次の処理件数
- **推定コスト**: API利用料金の概算計算
- **平均使用量**: ユーザーあたりの利用統計

### パフォーマンス指標
- **処理時間監視**: 平均応答時間の追跡
- **エラー率監視**: システム障害の検知
- **使用パターン分析**: 時間帯別・ユーザー別の利用傾向

---

## 🛡️ セキュリティ仕様

### 認証・認可
- **パスワード**: 6文字以上の要求
- **セッション管理**: Redis での安全なセッション保存
- **権限制御**: ロールベースアクセス制御
- **管理者保護**: admin ユーザーの特別保護

### データ保護
- **環境変数**: APIキー・認証情報の安全な管理
- **HTTPS**: 本番環境での暗号化通信
- **入力検証**: XSS・インジェクション攻撃対策
- **ファイルアップロード制限**: 不正ファイルの防止

---

## 📁 ファイル構造

### 重要なファイル・ディレクトリ

```
telop-ai-tool-v2/
├── src/
│   ├── app/                    # Next.js App Router
│   │   ├── api/               # API エンドポイント
│   │   │   ├── admin/         # 管理機能API
│   │   │   ├── process-media/ # メディア処理API
│   │   │   └── auth/          # 認証API
│   │   └── page.tsx           # メインページ
│   ├── components/            # React コンポーネント
│   │   ├── AdminPanel.tsx     # 管理画面
│   │   ├── AdminManualModal.tsx # 管理マニュアル
│   │   ├── HelpModal.tsx      # ヘルプ画面
│   │   └── FeedbackModal.tsx  # フィードバック機能
│   └── utils/                 # ユーティリティ
│       └── userManagerRedis.ts # Redis ユーザー管理
├── settings/                  # 設定ファイル
│   └── email-settings.json    # メール通知設定
├── feedback/                  # フィードバックデータ
├── uploads/                   # アップロードファイル（一時）
├── .env.local                # 環境変数（重要）
├── vercel.json               # Vercel設定（Cron Jobs）
└── package.json              # 依存関係
```

---

## 🌐 環境変数設定

### 必須環境変数（.env.local）

```bash
# OpenAI API
OPENAI_API_KEY=sk-proj-xxxxx...

# Upstash Redis
UPSTASH_REDIS_REST_URL=https://worthy-skylark-59424.upstash.io
UPSTASH_REDIS_REST_TOKEN=xxxxx...

# Gmail SMTP（メール通知）
SMTP_USER=nonnooz0526@gmail.com
SMTP_PASS=nlqm jotj fgux pmbo

# Cron認証
CRON_SECRET=telop-cron-secret-key
```

### 本番環境での注意点
- 全ての環境変数をVercelの設定画面で設定する
- APIキーの定期ローテーション推奨
- SMTP パスワードはGmailアプリパスワードを使用

---

## 🚀 デプロイ・運用

### デプロイ手順
1. **GitHub**: コードをプッシュ
2. **Vercel**: 自動デプロイ実行
3. **環境変数**: Vercel設定画面で設定
4. **動作確認**: 本番環境での機能テスト

### Cron Jobs設定
```json
{
  "crons": [
    {
      "path": "/api/admin/send-daily-report",
      "schedule": "0 * * * *"
    }
  ]
}
```

### 監視項目

#### 🚨 最重要監視項目
1. **OpenAI API 残高監視**
   - **頻度**: 週2回以上（推奨：毎日）
   - **方法**: OpenAI Usage Dashboard で確認
   - **アラート**: 残高 $10 以下で即座にチャージ
   - **影響**: 残高不足 → システム完全停止

2. **OpenAI API 使用量急増監視**
   - **異常使用**: 日次使用量が通常の3倍以上
   - **原因**: 不正利用、システムバグ、ループ処理
   - **対処**: 即座に原因調査、必要に応じてシステム停止

#### 📊 通常監視項目
- **API レスポンス時間**: 平均3秒以内
- **エラー率**: 5%以下を維持
- **Upstash Redis 使用量**: 無料制限の80%以下を維持
- **ディスク使用量**: アップロードファイルの定期削除
- **メール送信成功率**: 95%以上を目標

---

## 📊 コスト管理

### 月間推定コスト（100リクエスト/月の場合）

| サービス | 月間コスト | 内容 |
|----------|------------|------|
| OpenAI API | $7.80 | 100リクエスト × $0.078 |
| Upstash Redis | $0* | 無料プラン範囲内（制限内） |
| Vercel | $0 | Hobbyプラン |
| Gmail SMTP | $0 | 無料範囲 |
| **合計** | **$7.80** | *Redis制限超過時は追加コスト発生 |

**＊Upstash Redis 無料プラン制限**：
- 256MB データサイズ
- 500K コマンド/月  
- 10GB 帯域幅/月
- 制限超過時：$0.20/100Kコマンド

### コスト最適化施策
- **使用制限**: ユーザー別月次クレジット制
- **ファイル削除**: 処理後の自動ファイル削除
- **キャッシュ活用**: 同一処理の重複回避
- **アラート設定**: 異常使用量の早期検知

---

## 🔍 トラブルシューティング

### よくある問題と対処法

#### 1. ユーザーがログインできない
- **原因**: アカウント無効化、パスワード間違い
- **対処**: 管理画面でユーザー状態確認、パスワードリセット

#### 2. メール通知が送信されない
- **原因**: SMTP設定エラー、Gmail制限
- **対処**: 環境変数確認、テストメール送信

#### 3. API コストが急増
- **原因**: 異常使用、制限回避、システムループ
- **対処**: 使用統計確認、ユーザー制限見直し、必要に応じてシステム緊急停止

#### 0. 🚨 OpenAI API 残高不足（最優先対応）
- **症状**: APIエラー、システム機能停止
- **即座の対処**: OpenAI アカウントへの入金（$50以上推奨）
- **確認方法**: https://platform.openai.com/account/billing
- **予防**: 残高 $10 以下になる前に事前入金

#### 4. ファイル処理エラー
- **原因**: ファイル形式不対応、サイズ制限
- **対処**: 対応形式確認、ファイルサイズ制限調整

---

## 📞 サポート・連絡先

### 技術サポート
- **方法**: ツール内フィードバック機能
- **対応時間**: 平日9:00-18:00
- **緊急時**: システム管理者への直接連絡

### システム管理者情報
- **Gmail**: nonnooz0526@gmail.com
- **GitHub**: リポジトリ管理者
- **Vercel**: デプロイ管理者

---

## 📅 メンテナンススケジュール

### 定期メンテナンス

#### 🚨 毎日実施（重要）
- **OpenAI API 残高確認**: Usage Dashboard チェック
- **異常使用量監視**: 前日の使用量が通常範囲内か確認
- **自動メール送信確認**: 日次レポートが正常送信されているか

#### 週次メンテナンス  
- **OpenAI API 詳細分析**: 週間使用量・コスト推移の確認
- **ユーザー使用状況レビュー**: アクティブユーザー・制限超過者の確認
- **Upstash Redis 使用量確認**: 無料制限内の使用状況確認

#### 月次メンテナンス
- **クレジット自動リセット**: 全ユーザーの月次制限リセット確認
- **コスト分析**: 月間総コスト・ユーザー別コスト分析
- **システム最適化**: 不要データ削除、パフォーマンス改善

#### 四半期メンテナンス
- **システム全体の見直し**: セキュリティ・機能・コストの包括的レビュー
- **アップデート計画**: 新機能・改善項目の検討・実装

### バックアップ
- **Redis データ**: Upstash 自動バックアップ
- **設定ファイル**: Git バージョン管理
- **環境変数**: 管理者による安全な保管

---

*最終更新: 2025年8月10日*  
*管理者: AI テロップツール v2 運用チーム*